<!DOCTYPE html>
<html>
<head>
<title>readme.md</title>
<meta http-equiv="Content-type" content="text/html;charset=UTF-8">

<style>
/* https://github.com/microsoft/vscode/blob/master/extensions/markdown-language-features/media/markdown.css */
/*---------------------------------------------------------------------------------------------
 *  Copyright (c) Microsoft Corporation. All rights reserved.
 *  Licensed under the MIT License. See License.txt in the project root for license information.
 *--------------------------------------------------------------------------------------------*/

body {
	font-family: var(--vscode-markdown-font-family, -apple-system, BlinkMacSystemFont, "Segoe WPC", "Segoe UI", "Ubuntu", "Droid Sans", sans-serif);
	font-size: var(--vscode-markdown-font-size, 14px);
	padding: 0 26px;
	line-height: var(--vscode-markdown-line-height, 22px);
	word-wrap: break-word;
}

#code-csp-warning {
	position: fixed;
	top: 0;
	right: 0;
	color: white;
	margin: 16px;
	text-align: center;
	font-size: 12px;
	font-family: sans-serif;
	background-color:#444444;
	cursor: pointer;
	padding: 6px;
	box-shadow: 1px 1px 1px rgba(0,0,0,.25);
}

#code-csp-warning:hover {
	text-decoration: none;
	background-color:#007acc;
	box-shadow: 2px 2px 2px rgba(0,0,0,.25);
}

body.scrollBeyondLastLine {
	margin-bottom: calc(100vh - 22px);
}

body.showEditorSelection .code-line {
	position: relative;
}

body.showEditorSelection .code-active-line:before,
body.showEditorSelection .code-line:hover:before {
	content: "";
	display: block;
	position: absolute;
	top: 0;
	left: -12px;
	height: 100%;
}

body.showEditorSelection li.code-active-line:before,
body.showEditorSelection li.code-line:hover:before {
	left: -30px;
}

.vscode-light.showEditorSelection .code-active-line:before {
	border-left: 3px solid rgba(0, 0, 0, 0.15);
}

.vscode-light.showEditorSelection .code-line:hover:before {
	border-left: 3px solid rgba(0, 0, 0, 0.40);
}

.vscode-light.showEditorSelection .code-line .code-line:hover:before {
	border-left: none;
}

.vscode-dark.showEditorSelection .code-active-line:before {
	border-left: 3px solid rgba(255, 255, 255, 0.4);
}

.vscode-dark.showEditorSelection .code-line:hover:before {
	border-left: 3px solid rgba(255, 255, 255, 0.60);
}

.vscode-dark.showEditorSelection .code-line .code-line:hover:before {
	border-left: none;
}

.vscode-high-contrast.showEditorSelection .code-active-line:before {
	border-left: 3px solid rgba(255, 160, 0, 0.7);
}

.vscode-high-contrast.showEditorSelection .code-line:hover:before {
	border-left: 3px solid rgba(255, 160, 0, 1);
}

.vscode-high-contrast.showEditorSelection .code-line .code-line:hover:before {
	border-left: none;
}

img {
	max-width: 100%;
	max-height: 100%;
}

a {
	text-decoration: none;
}

a:hover {
	text-decoration: underline;
}

a:focus,
input:focus,
select:focus,
textarea:focus {
	outline: 1px solid -webkit-focus-ring-color;
	outline-offset: -1px;
}

hr {
	border: 0;
	height: 2px;
	border-bottom: 2px solid;
}

h1 {
	padding-bottom: 0.3em;
	line-height: 1.2;
	border-bottom-width: 1px;
	border-bottom-style: solid;
}

h1, h2, h3 {
	font-weight: normal;
}

table {
	border-collapse: collapse;
}

table > thead > tr > th {
	text-align: left;
	border-bottom: 1px solid;
}

table > thead > tr > th,
table > thead > tr > td,
table > tbody > tr > th,
table > tbody > tr > td {
	padding: 5px 10px;
}

table > tbody > tr + tr > td {
	border-top: 1px solid;
}

blockquote {
	margin: 0 7px 0 5px;
	padding: 0 16px 0 10px;
	border-left-width: 5px;
	border-left-style: solid;
}

code {
	font-family: Menlo, Monaco, Consolas, "Droid Sans Mono", "Courier New", monospace, "Droid Sans Fallback";
	font-size: 1em;
	line-height: 1.357em;
}

body.wordWrap pre {
	white-space: pre-wrap;
}

pre:not(.hljs),
pre.hljs code > div {
	padding: 16px;
	border-radius: 3px;
	overflow: auto;
}

pre code {
	color: var(--vscode-editor-foreground);
	tab-size: 4;
}

/** Theming */

.vscode-light pre {
	background-color: rgba(220, 220, 220, 0.4);
}

.vscode-dark pre {
	background-color: rgba(10, 10, 10, 0.4);
}

.vscode-high-contrast pre {
	background-color: rgb(0, 0, 0);
}

.vscode-high-contrast h1 {
	border-color: rgb(0, 0, 0);
}

.vscode-light table > thead > tr > th {
	border-color: rgba(0, 0, 0, 0.69);
}

.vscode-dark table > thead > tr > th {
	border-color: rgba(255, 255, 255, 0.69);
}

.vscode-light h1,
.vscode-light hr,
.vscode-light table > tbody > tr + tr > td {
	border-color: rgba(0, 0, 0, 0.18);
}

.vscode-dark h1,
.vscode-dark hr,
.vscode-dark table > tbody > tr + tr > td {
	border-color: rgba(255, 255, 255, 0.18);
}

</style>

<style>
/* Tomorrow Theme */
/* http://jmblog.github.com/color-themes-for-google-code-highlightjs */
/* Original theme - https://github.com/chriskempson/tomorrow-theme */

/* Tomorrow Comment */
.hljs-comment,
.hljs-quote {
	color: #8e908c;
}

/* Tomorrow Red */
.hljs-variable,
.hljs-template-variable,
.hljs-tag,
.hljs-name,
.hljs-selector-id,
.hljs-selector-class,
.hljs-regexp,
.hljs-deletion {
	color: #c82829;
}

/* Tomorrow Orange */
.hljs-number,
.hljs-built_in,
.hljs-builtin-name,
.hljs-literal,
.hljs-type,
.hljs-params,
.hljs-meta,
.hljs-link {
	color: #f5871f;
}

/* Tomorrow Yellow */
.hljs-attribute {
	color: #eab700;
}

/* Tomorrow Green */
.hljs-string,
.hljs-symbol,
.hljs-bullet,
.hljs-addition {
	color: #718c00;
}

/* Tomorrow Blue */
.hljs-title,
.hljs-section {
	color: #4271ae;
}

/* Tomorrow Purple */
.hljs-keyword,
.hljs-selector-tag {
	color: #8959a8;
}

.hljs {
	display: block;
	overflow-x: auto;
	color: #4d4d4c;
	padding: 0.5em;
}

.hljs-emphasis {
	font-style: italic;
}

.hljs-strong {
	font-weight: bold;
}
</style>

<style>
/*
 * Markdown PDF CSS
 */

 body {
	font-family: -apple-system, BlinkMacSystemFont, "Segoe WPC", "Segoe UI", "Ubuntu", "Droid Sans", sans-serif, "Meiryo";
	padding: 0 12px;
}

pre {
	background-color: #f8f8f8;
	border: 1px solid #cccccc;
	border-radius: 3px;
	overflow-x: auto;
	white-space: pre-wrap;
	overflow-wrap: break-word;
}

pre:not(.hljs) {
	padding: 23px;
	line-height: 19px;
}

blockquote {
	background: rgba(127, 127, 127, 0.1);
	border-color: rgba(0, 122, 204, 0.5);
}

.emoji {
	height: 1.4em;
}

code {
	font-size: 14px;
	line-height: 19px;
}

/* for inline code */
:not(pre):not(.hljs) > code {
	color: #C9AE75; /* Change the old color so it seems less like an error */
	font-size: inherit;
}

/* Page Break : use <div class="page"/> to insert page break
-------------------------------------------------------- */
.page {
	page-break-after: always;
}

</style>

<script src="https://unpkg.com/mermaid/dist/mermaid.min.js"></script>
</head>
<body>
  <script>
    mermaid.initialize({
      startOnLoad: true,
      theme: document.body.classList.contains('vscode-dark') || document.body.classList.contains('vscode-high-contrast')
          ? 'dark'
          : 'default'
    });
  </script>
<h1 id="%E5%B9%B6%E8%A1%8C%E7%A8%8B%E5%BA%8F%E8%AE%BE%E8%AE%A1-%E8%AE%A1%E6%97%B6%E5%99%A8%E4%BD%9C%E4%B8%9A">并行程序设计 计时器作业</h1>
<blockquote>
<p>2100011025 工学院 王奕博</p>
</blockquote>
<h2 id="%E7%BC%96%E8%AF%91%E8%AF%B4%E6%98%8E">编译说明</h2>
<p>在当前路径下，使用</p>
<pre class="hljs"><code><div>make
</div></code></pre>
<p>进行编译，之后使用</p>
<pre class="hljs"><code><div>./timer
</div></code></pre>
<p>查看结果。</p>
<h2 id="%E7%A8%8B%E5%BA%8F%E6%9E%B6%E6%9E%84">程序架构</h2>
<p>程序的主要架构由record类和timer类构成。record类包含四个成员变量和一些成员函数，成员变量包括类名、函数名、被调用次数以及vector类型的每次被调用的时间，成员函数包括了一些简单的求和、求平均等功能，以及添加新的调用记录等。</p>
<p>它的具体构造如下:</p>
<pre class="hljs"><code><div><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">record</span>
{</span>
<span class="hljs-keyword">public</span>:
        <span class="hljs-built_in">string</span> class_name;
        <span class="hljs-built_in">string</span> func_name;
        <span class="hljs-keyword">int</span> times;
        <span class="hljs-built_in">vector</span>&lt;<span class="hljs-keyword">double</span>&gt; history;<span class="hljs-comment">// the records of duration of a certain function</span>
        record(<span class="hljs-built_in">string</span> c,<span class="hljs-built_in">string</span> f):class_name(c),func_name(f)
        {
                times = <span class="hljs-number">0</span>;
                history.<span class="hljs-built_in">clear</span>();
        }
        ~record(){}
        <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">add</span><span class="hljs-params">(<span class="hljs-keyword">double</span> record)</span><span class="hljs-comment">// add a new record to the history</span>
        </span>{
                times += <span class="hljs-number">1</span>;
                history.push_back(record);
        }
        <span class="hljs-function"><span class="hljs-keyword">double</span> <span class="hljs-title">total</span><span class="hljs-params">()</span><span class="hljs-comment">// calculate total time</span>
        </span>{...}
        <span class="hljs-function"><span class="hljs-keyword">double</span> <span class="hljs-title">average</span><span class="hljs-params">()</span><span class="hljs-comment">// calculate average time</span>
        </span>{...}
};
</div></code></pre>
<p>timer类则主要由一些静态成员函数和静态变量构成，这使得在使用timer类的时候无需实例化某个特定的timer类，直接调用相关函数即可。</p>
<p>timer类的记录是由一个储存record类的vector实现的，即：</p>
<pre class="hljs"><code><div><span class="hljs-keyword">static</span> <span class="hljs-built_in">vector</span>&lt;record&gt; records;<span class="hljs-comment">// store the record class</span>
</div></code></pre>
<p>timer类用std库中的map来记录已经出现过的函数名和类名，这里使用pair将两个string并为整体，并使用</p>
<pre class="hljs"><code><div><span class="hljs-keyword">static</span> <span class="hljs-built_in">map</span>&lt;pair&lt;<span class="hljs-built_in">string</span>, <span class="hljs-built_in">string</span>&gt;, <span class="hljs-keyword">int</span>&gt; entry;
</div></code></pre>
<p>来记录以及防止重复。</p>
<p>同时，timer类使用chrono库中的相关功能来实现计时器的功能，定义的变量如下：</p>
<pre class="hljs"><code><div><span class="hljs-keyword">static</span> chrono::time_point&lt;chrono::steady_clock&gt; start_time;
</div></code></pre>
<p>此外，还使用了一个bool类型的flag，每当使用一次tick函数时，flag会从0变成1或者从1变成0，用来开启或者关闭计时器。</p>
<p>主要的tick函数控制计时功能，它的结构如下：</p>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">tick</span><span class="hljs-params">(<span class="hljs-keyword">const</span> <span class="hljs-built_in">string</span>&amp; class_name, <span class="hljs-keyword">const</span> <span class="hljs-built_in">string</span>&amp; function_name)</span>
        </span>{
                        start_time = chrono::steady_clock::now();
                {
                        flag = <span class="hljs-number">1</span>;
                        start_time = chrono::steady_clock::now();
                }
                <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (flag == <span class="hljs-number">1</span>)
                {
                        chrono::duration&lt;<span class="hljs-keyword">float</span>&gt; chrono_duration = chrono::steady_clock::now() - start_time;
                        <span class="hljs-keyword">double</span> duration = chrono_duration.count();

                        pair&lt;<span class="hljs-built_in">string</span>, <span class="hljs-built_in">string</span>&gt; name;
                        name = make_pair(class_name, function_name);
                        <span class="hljs-built_in">map</span>&lt;pair&lt;<span class="hljs-built_in">string</span>, <span class="hljs-built_in">string</span>&gt;, <span class="hljs-keyword">int</span>&gt;::iterator it;
                        it = entry.<span class="hljs-built_in">find</span>(name);
                        <span class="hljs-keyword">if</span> (it == entry.<span class="hljs-built_in">end</span>())<span class="hljs-comment">// if the function have not appeared</span>
                        {
                                record new_record = record(class_name,function_name);
                                new_record.add(duration);
                                <span class="hljs-keyword">int</span> index = entry.<span class="hljs-built_in">size</span>();
                                entry[name] = index;
                                records.push_back(new_record);
                        }
                        <span class="hljs-keyword">else</span><span class="hljs-comment">// if it has appeared</span>
                        {
                                <span class="hljs-keyword">int</span> index = it-&gt;second;
                                records[index].add(duration);
                        }
                        total_time += duration;
                        flag = <span class="hljs-number">0</span>;
                }
        }
</div></code></pre>
<p>如果是第一次打开，tick函数会开始计时；第二次打开时，tick函数立即关闭计时器（为了防止其它操作也被计入计时），之后确定被计时的函数是否已经被记录过。如果被记录则找到那条record类，向其中加入这条记录；如果没有，则加入新的record类。</p>
<h2 id="%E6%B5%8B%E8%AF%95%E7%BB%93%E6%9E%9C">测试结果</h2>
<p>在这里，我想测试cmath库中exp(),sin(),log()哪一种函数消耗的时间最长。我分别计算$\sum_{i=1}^{200} exp(i)$,$\sum_{i=1}^{200} sin(i)$,$\sum_{i=1}^{200} log(i)$的值，这其中每一种函数都被调用了200次。</p>
<p>测试的Main函数如下：</p>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-keyword">int</span> argc,<span class="hljs-keyword">char</span>** argv)</span>
</span>{
        <span class="hljs-keyword">double</span> y;
        <span class="hljs-comment">// here's my test for the average time consuming of three functions,log(x),exp(x) and sin(x). </span>
        <span class="hljs-comment">// the result shows sin(x) is the slowest of three all.</span>
        <span class="hljs-comment">// emmm...sometimes log(x) takes the most time. i dont know why :( </span>
        y = <span class="hljs-number">1.0</span>;
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">1</span>; i &lt;= <span class="hljs-number">200</span>; i++)
        {
                timer::tick(<span class="hljs-string">"none"</span>, <span class="hljs-string">"log"</span>);
                y = y + <span class="hljs-built_in">log</span>(i);
                timer::tick(<span class="hljs-string">"none"</span>, <span class="hljs-string">"log"</span>);
        }

        y = <span class="hljs-number">1.0</span>;
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">1</span>; i &lt;= <span class="hljs-number">200</span>; i++)
        {
                timer::tick(<span class="hljs-string">"none"</span>, <span class="hljs-string">"exp"</span>);
                y = y + <span class="hljs-built_in">exp</span>(i);
                timer::tick(<span class="hljs-string">"none"</span>, <span class="hljs-string">"exp"</span>);
        }

        y = <span class="hljs-number">1.0</span>;
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">1</span>; i &lt;= <span class="hljs-number">200</span>; i++)
        {
                timer::tick(<span class="hljs-string">"none"</span>, <span class="hljs-string">"sin"</span>);
                y = y + <span class="hljs-built_in">sin</span>(i);
                timer::tick(<span class="hljs-string">"none"</span>, <span class="hljs-string">"sin"</span>);
        }

        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}
</div></code></pre>
<p>编译之后，几次结果为：</p>
<pre class="hljs"><code><div>|CLASS_NAME-----|NAME----------|TIME(sec)-----|CALLS---------|AVG-----------|PER%----------|
          TOTAL          TOTAL     7.0359e-05                                          100 %
           none            log     2.7429e-05            200    1.37145e-07        38.9844 %
           none            exp     1.6196e-05            200      8.098e-08        23.0191 %
           none            sin     2.6734e-05            200     1.3367e-07        37.9966 %  
</div></code></pre>
<pre class="hljs"><code><div>|CLASS_NAME-----|NAME----------|TIME(sec)-----|CALLS---------|AVG-----------|PER%----------|
          TOTAL          TOTAL       6.93e-05                                          100 %
           none            log     2.6329e-05            200    1.31645e-07        37.9928 %
           none            exp     1.6203e-05            200     8.1015e-08         23.381 %
           none            sin     2.6768e-05            200     1.3384e-07        38.6263 %
</div></code></pre>
<pre class="hljs"><code><div>|CLASS_NAME-----|NAME----------|TIME(sec)-----|CALLS---------|AVG-----------|PER%----------|
          TOTAL          TOTAL     8.5729e-05                                          100 %
           none            log     2.6346e-05            200     1.3173e-07        30.7317 %
           none            exp     2.0504e-05            200     1.0252e-07        23.9172 %
           none            sin     3.8879e-05            200    1.94395e-07         45.351 %
</div></code></pre>
<p>故结果是，log和sin占用的时间比exp长。</p>
<h2 id="%E4%B8%80%E4%BA%9B%E4%B8%8D%E8%B6%B3">一些不足</h2>
<p>一个尚未解决的不足之处：</p>
<p>在这里，如果我将计时器放在for循环外而非循环内，占用的总时间会少大约30%，这表明从调用tick()函数到计时被中止（其实只是调用开销+一行if判断，之后的时间并不计入计时），所占用的时间和调用log()等函数基本在同一个数量级内。我试图优化了一小部分，但是没有显著的方法减少这个时间。</p>
<p>其实这个时间并不长，不过为了这个tick()能够更好的工作，应该尽量使得每次调用的间隔长一点，这样误差会更小。</p>

</body>
</html>
